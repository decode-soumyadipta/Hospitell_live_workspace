<!-- templates/HOSPITAL/show_lab_test_bookings.html -->
{% extends "HOSPITAL/hospital_base_layout.html" %}
{% block title %}Lab Test Bookings{% endblock %}
{% block content %}
<main id="main" class="main">

    <div class="pagetitle">
        <h1>Lab Test Bookings</h1>
    </div><!-- End Page Title -->

    <section class="section">
        <div class="row">
            <div class="col-lg-12">

                <!-- Lab Test Bookings List -->
                <div class="card">
                    <div class="card-body">
                        <h5 class="card-title">Bookings</h5>
                        <table class="table table-bordered">
                            <thead>
                                <tr>
                                    <th>Sl no.</th>
                                    <th>Patient Name</th>
                                    <th>Test Category</th>
                                    <th>Test Name</th>
                                    <th>Date</th>
                                    <th>Status</th>
                                    <th>Actions</th>
                               </tr>
                            </thead>
                            <tbody>
                                {% for booking in bookings %}
                                    <tr id="booking-row-{{ booking.id }}">
                                        <td>{{ loop.index }}</td>
                                        <td>{{ booking.user.name }}</td>
                                        <td>{{ booking.test_category }}</td>
                                        <td>{{ booking.test_name }}</td>
                                        <td>{{ booking.booking_date }}</td>
                                        
                                        <td id="status-{{ booking.id }}">
                                            {% if booking.status == 'CheckedIn' %}
                                                <span class="text-success">Checked In</span>
                                            {% else %}
                                                <span class="text-warning">Pending</span>
                                            {% endif %}
                                        </td>
                                        <td>
                                            {% if booking.status != 'CheckedIn' %}
                                                <button class="btn btn-primary btn-sm" id="verify-btn-{{ booking.id }}" onclick="showVerificationField({{ booking.id }})">Verify</button>
                                                <div id="verification-field-{{ booking.id }}" class="verification-field" style="display: none;">
                                                    <input type="text" id="booking-code-{{ booking.id }}" placeholder="Enter booking code">
                                                    <button class="btn btn-success btn-sm" onclick="verifyCode({{ booking.id }})">Submit</button>
                                                </div>
                                            {% endif %}
                                        </td>
                                    </tr>
                                {% endfor %}
                            </tbody>
                        </table>
                    </div>
                </div>

            </div>
        </div>
    </section>

</main>

<script>
    // Show verification field when the "Verify" button is clicked
    function showVerificationField(bookingId) {
        document.getElementById(`verification-field-${bookingId}`).style.display = 'block';
    }

    // Function to verify the booking code
    function verifyCode(bookingId) {
        const bookingCode = document.getElementById(`booking-code-${bookingId}`).value;

        fetch(`/verify_test_booking_code/${bookingId}`, {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
            },
            body: JSON.stringify({ booking_code: bookingCode })
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                document.getElementById(`status-${bookingId}`).innerHTML = '<span class="text-success">Checked In</span>';
                alert('Booking code verified successfully!');

                // Hide the verify button and text field after successful verification
                document.getElementById(`verification-field-${bookingId}`).style.display = 'none';
                document.getElementById(`verify-btn-${bookingId}`).style.display = 'none';
            } else {
                alert('Invalid booking code.');
            }
        })
        .catch(error => {
            alert('An error occurred. Please try again.');
            console.error('Error:', error);
        });
    }
</script>
{% endblock %}
